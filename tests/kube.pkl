amends "pkl:test"

import "../Kube.pkl"

local fullKube = new Kube {
    unit = new {
        description = "Test Kubernetes Deployment"
        after = "network.target"
    }
    
    kube = new {
        yaml = "/app/k8s/test.yaml"
        autoUpdate = "registry"
        
        configMap = new Listing {
            "/app/k8s/config.yaml"
            "/app/k8s/secrets.yaml"
        }
        
        network = "test-net"
        
        publishPort = new Listing {
            "8080:80"
            "9090:9090"
        }
        
        exitCodePropagation = "any"
        workingDirectory = "/app/k8s"
        setWorkingDirectory = "/app"
        
        userNS = "auto"
        
        logDriver = "journald"
        
        // New official Quadlet fields
        containersConfModule = new Listing {
            "/etc/containers/test.conf"
        }
        
        globalArgs = new Listing {
            "--log-level=debug"
        }
        
        kubeDownForce = true
        
        // Unsupported fields moved to podmanArgs
        podmanArgs {
            "--uidmap=0:100000:65536"
            "--gidmap=0:100000:65536"
            "--security-opt=label:disable=false"
            "--security-opt=label:type=container_t"
            "--volume=/var/log/test:/var/log:Z"
            "--volume=/data:/data:Z"
            "--annotation=test.key=test.value"
            "--log-level=info"
            "--replace"
            "--start"
        }
    }
    
    install = new {
        wantedBy = "multi-user.target"
    }
}

local simpleKube = new Kube {
    kube = new {
        yaml = "/simple/app.yaml"
    }
}

examples {
    ["full kube quadlet"] {
        fullKube.output.text
    }
    
    ["simple kube quadlet"] {
        simpleKube.output.text
    }
}
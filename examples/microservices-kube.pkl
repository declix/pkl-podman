amends "../Kube.pkl"

unit = new {
    description = "Microservices Stack"
    after = new Listing {
        "network.target"
        "webapp-network.service"
    }
    requires = "webapp-network.service"
}

kube = new {
    yaml = "/app/k8s/microservices.yaml"
    autoUpdate = "local"
    
    configMap = new Listing {
        "/app/k8s/config/app-config.yaml"
        "/app/k8s/config/database-config.yaml"
        "/app/k8s/secrets/api-keys.yaml"
    }
    
    network = "microservices"
    
    publishPort = new Listing {
        "3000:3000"   // API Gateway
        "3001:3001"   // User Service
        "3002:3002"   // Order Service
        "9090:9090"   // Prometheus
    }
    
    exitCodePropagation = "all"
    setWorkingDirectory = "/app/k8s"
    
    // User namespace for security
    userNS = "auto"
    
    // Use podmanArgs for unsupported Quadlet fields
    podmanArgs {
        "--uidmap=0:100000:65536"
        "--gidmap=0:100000:65536"
        "--volume=postgres-data:/var/lib/postgresql/data:Z"
        "--volume=redis-data:/data:Z"
        "--volume=/app/logs:/var/log/app:Z"
        "--volume=/app/uploads:/uploads:Z"
    }
    
    logDriver = "journald"
}

install = new {
    wantedBy = "multi-user.target"
}
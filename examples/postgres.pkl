amends "../Container.pkl"

unit = new {
    description = "PostgreSQL Database Container"
    after = "network-online.target"
    requires = "network-online.target"
}

container = new {
    image = "docker.io/library/postgres:15"
    containerName = "postgres"
    
    publishPort = new Listing {
        "5432:5432"
    }
    
    volume = new Listing {
        "postgres-data:/var/lib/postgresql/data"
        "/etc/postgresql/postgresql.conf:/etc/postgresql/postgresql.conf:ro"
    }
    
    environment {
        ["POSTGRES_DB"] = "myapp"
        ["POSTGRES_USER"] = "myuser"
        ["POSTGRES_PASSWORD"] = "mypassword"
        ["PGDATA"] = "/var/lib/postgresql/data/pgdata"
    }
    
    pull = "missing"
    
    healthCmd = "pg_isready -U myuser -d myapp"
    healthInterval = 10.s
    healthTimeout = 5.s
    healthRetries = 5
    healthStartPeriod = 30.s
    
    podmanArgs {
        "--memory=1G"
        "--cpus=2.0"
    }
}

service = new {
    restart = "on-failure" 
    restartSec = 10.s
    timeoutStartSec = 90.s
}

install = new {
    wantedBy = "multi-user.target"
}